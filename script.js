// Generated by CoffeeScript 1.6.3
(function() {
  var $head, $segments, $snake, animate, audioElement, baseVelocity, chargingMyLaser, chargingMyLaserTimeout, getRotation, i, laserIsCharging, maxLaser, maxSnare, maxVelocity, minLength, onCanPlay, pewpew, pewpewThrottled, shootLaser, snakeRads, snakeX, snakeY, transform, transformQueue, turnDirection, velocity, whip, xMax, xMin, yMax, yMin, _i, _ref;

  audioElement = document.createElement('audio');

  audioElement.setAttribute('id', 'audio');

  audioElement.setAttribute('preload', 'auto');

  audioElement.setAttribute('type', 'audio/mpeg');

  audioElement.setAttribute('loop', '');

  document.body.insertBefore(audioElement, document.body.firstChild);

  audioElement.setAttribute('src', 'pewpew1.mp3');

  $snake = $('.snake');

  $head = $('.head');

  $segments = $('.segment');

  snakeRads = Math.PI / 2;

  snakeX = 100;

  snakeY = -100;

  maxVelocity = 7;

  baseVelocity = 2.5;

  velocity = baseVelocity;

  transformQueue = [];

  for (i = _i = 0, _ref = $segments.length * 5; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
    transform = "translate(" + snakeX + "px, " + (-snakeY + 4 * i) + "px)";
    transformQueue.push({
      '-webkit-transform': transform,
      transform: transform
    });
  }

  xMin = 20;

  yMin = -20;

  xMax = window.innerWidth - 60;

  yMax = -(window.innerHeight - 60);

  minLength = 120;

  turnDirection = 0;

  getRotation = function() {
    var cosine, rotation, sine, xLength, yLength;
    sine = Math.sin(snakeRads);
    cosine = Math.cos(snakeRads);
    xLength = ((cosine > 0 ? xMax : xMin) - snakeX) / cosine;
    yLength = ((sine < 0 ? yMax : yMin) - snakeY) / sine;
    rotation = Math.sin(Date.now() / 150) / 10;
    if (xLength < minLength || yLength < minLength) {
      if (turnDirection === 0) {
        turnDirection = rotation > 0 ? -1 : 1;
      }
      return 0.2 * turnDirection;
    } else {
      turnDirection = 0;
      return rotation;
    }
  };

  animate = function() {
    requestAnimationFrame(animate);
    snakeRads += getRotation();
    snakeX = snakeX + velocity * Math.cos(snakeRads);
    snakeY = snakeY + velocity * Math.sin(snakeRads);
    transform = "translate(" + snakeX + "px, " + (-snakeY) + "px) rotate(" + (-snakeRads) + "rad)";
    transformQueue.unshift({
      '-webkit-transform': transform,
      transform: transform
    });
    $snake.children().each(function(i) {
      return $(this).css(transformQueue[i * 5]);
    });
    transformQueue.pop();
    if (velocity > baseVelocity) {
      return velocity -= 1;
    } else {
      return velocity = baseVelocity;
    }
  };

  shootLaser = function() {
    var $laser1, $laser2, transform1, transform2, x1, x2, y1, y2;
    console.log('pew pew');
    $laser1 = $('<div class="laser">');
    $laser2 = $('<div class="laser">');
    x1 = snakeX + 20 + 12 * Math.cos(snakeRads) + 12 * Math.sin(snakeRads);
    y1 = snakeY - 18 + 12 * Math.sin(snakeRads) - 12 * Math.cos(snakeRads);
    transform1 = "translate(" + x1 + "px, " + (-y1) + "px) rotate(" + (-snakeRads) + "rad)";
    $laser1.css({
      '-webkit-transform': transform1,
      transform: transform1
    });
    x2 = snakeX + 20 + 12 * Math.cos(snakeRads + 1.5) + 12 * Math.sin(snakeRads + 1.5);
    y2 = snakeY - 18 + 12 * Math.sin(snakeRads + 1.5) - 12 * Math.cos(snakeRads + 1.5);
    transform2 = "translate(" + x2 + "px, " + (-y2) + "px) rotate(" + (-snakeRads) + "rad)";
    $laser2.css({
      '-webkit-transform': transform2,
      transform: transform2
    });
    $('.snake-container').prepend($laser1, $laser2);
    requestAnimationFrame(function() {
      $laser1.css({
        '-webkit-transform': transform1 + ' scaleX(10)' + ' translateX(100px)',
        transform: transform1 + ' scaleX(18)' + ' translateX(200px)'
      });
      return $laser2.css({
        '-webkit-transform': transform2 + ' scaleX(10)' + ' translateX(100px)',
        transform: transform2 + ' scaleX(18)' + ' translateX(200px)'
      });
    });
    return setTimeout((function() {
      return $laser1.add($laser2).remove();
    }), 1000);
  };

  pewpewThrottled = false;

  maxLaser = 1;

  pewpew = function(array) {
    var laser;
    laser = array[91];
    if (laser / maxLaser < 0.90) {
      return;
    }
    if (laser > maxLaser) {
      maxLaser = laser;
    }
    if (laserIsCharging()) {
      return;
    }
    if (pewpewThrottled) {
      return;
    }
    requestAnimationFrame(shootLaser);
    pewpewThrottled = true;
    return setTimeout((function() {
      return pewpewThrottled = false;
    }), 150);
  };

  chargingMyLaser = true;

  chargingMyLaserTimeout = false;

  laserIsCharging = function() {
    if (chargingMyLaser && !chargingMyLaserTimeout) {
      chargingMyLaserTimeout = setTimeout((function() {
        return chargingMyLaser = false;
      }), 3500);
    }
    return chargingMyLaser;
  };

  maxSnare = 160;

  whip = function(array) {
    var snare, snareRatio;
    snare = array[382];
    if (snare > maxSnare) {
      maxSnare = snare;
    }
    snareRatio = snare / maxSnare;
    if (snareRatio > 0.75) {
      velocity += 5 * snare / maxSnare;
      if (velocity > maxVelocity) {
        return velocity = maxVelocity;
      }
    }
  };

  onCanPlay = function() {
    var analyser, array, audioContext, audioScript, audioSource, gain;
    this.removeEventListener('canplay', onCanPlay);
    audioContext = new (window.AudioContext || window.webkitAudioContext);
    console.log('sample rate:', audioContext.sampleRate);
    gain = audioContext.createGain();
    audioSource = audioContext.createMediaElementSource(audioElement);
    audioScript = audioContext.createScriptProcessor(512);
    analyser = audioContext.createAnalyser();
    analyser.smoothingTimeConstant = 0.2;
    analyser.fftSize = 1024;
    gain.gain.value = 0.2;
    audioSource.connect(gain);
    gain.connect(audioContext.destination);
    audioSource.connect(analyser);
    analyser.connect(audioScript);
    audioScript.connect(audioContext.destination);
    array = new Uint8Array(analyser.frequencyBinCount);
    audioScript.addEventListener('audioprocess', window.pin = function(e) {
      analyser.getByteFrequencyData(array);
      pewpew(array);
      return whip(array);
    });
    setTimeout(function() {
      return audioElement.play();
    }, 20);
    return audioElement.play();
  };

  audioElement.addEventListener('canplay', onCanPlay);

  animate();

}).call(this);
